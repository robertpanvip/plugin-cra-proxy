import fs from "node:fs";
import path from "node:path";
import url from "node:url";
import type { ProxyOptions, RsbuildPlugin, Rspack } from "@rsbuild/core";

const appDirectory = fs.realpathSync(process.cwd());
const resolveApp = (relativePath: string) =>
  path.resolve(appDirectory, relativePath);

function resolveLoopback(proxy: string): string {
  const o = url.parse(proxy);
  o.host = null;
  if (o.hostname !== "localhost") return proxy;

  o.hostname = "127.0.0.1";
  return url.format(o);
}

function createProxyPlugin(): RsbuildPlugin {
  return {
    name: "rsbuild-cra-proxy",
    setup(api) {
      let assets: string[] = [];
      const onProxyError = (proxy: string): ProxyOptions["onError"] => {
        return (err, req, res) => {
          const host = req.headers?.host;
          api.logger.error(
            `Proxy error: Could not proxy request ${req.url} from ${host} to ${proxy}.`,
          );
          api.logger.error(`(${err.message})`);

          if (res.writeHead && !res.headersSent) {
            res.writeHead(500);
          }
          res.end(
            `Proxy error: Could not proxy request ${req.url} from ${host} to ${proxy} (${err.message}).`,
          );
        };
      };

      // 把 proxy 注入到 devServer 配置
      api.modifyRsbuildConfig((config) => {
        function prepareProxy(): ProxyOptions[] | undefined {
          const pkg = require(resolveApp("package.json"));
          const proxy = pkg.proxy;

          if (!proxy) return undefined;
          if (typeof proxy !== "string") {
            api.logger.error(`"proxy" in package.json must be a string`);
            process.exit(1);
          }

          if (!/^http(s)?:\/\//.test(proxy)) {
            api.logger.error(`"proxy" must start with http:// or https://`);
            process.exit(1);
          }

          const target =
            process.platform === "win32" ? resolveLoopback(proxy) : proxy;
          const sockPath = "/rsbuild-hmr";
          const isDefaultSockHost = true;
          const mayProxy = (pathname: string, req: any) => {
            const isPublicFileRequest = assets.some(
              (as) => `/${as}` === pathname,
            );
            const isWdsEndpointRequest =
              isDefaultSockHost && pathname.startsWith(sockPath);

            if (req.headers.accept === "text/event-stream") {
              return false;
            }
            return !(isPublicFileRequest || isWdsEndpointRequest);
          };

          api.logger.start(`Proxy target: ${target}`);
          return [
            {
              target,
              logLevel: "silent",
              context: (pathname, req) => {
                return !!(
                  req.method !== "GET" ||
                  (req.headers.accept &&
                    req.headers.accept.indexOf("text/html") === -1 &&
                    mayProxy(pathname, req))
                );
              },
              onProxyReq: (proxyReq) => {
                if (proxyReq.getHeader("origin")) {
                  proxyReq.setHeader("origin", target);
                }
              },
              onError: onProxyError(target),
              secure: false,
              changeOrigin: true,
              ws: true,
              xfwd: true,
            },
          ];
        }
        config.server ??= {};
        config.server.proxy = prepareProxy();
      });
      api.onDevCompileDone((v) => {
        const { publicDir } = api.getNormalizedConfig().server;
        let stats: Rspack.Stats[] = [];
        if ("stats" in v.stats) {
          stats = v.stats.stats;
        } else {
          stats = [v.stats];
        }
        const as = stats.flatMap((item) => {
          const assets = item.compilation.assets;
          return Object.keys(assets);
        });
        assets = [...as];
        publicDir.forEach((dir) => {
          const dirName=dir.name
          if (fs.existsSync(dirName)) {
            function getAllFiles(dir: string, fileList: string[] = []) {
              const files = fs.readdirSync(dir);
              files.forEach((file) => {
                const filePath = path.join(dir, file);
                if (fs.statSync(filePath).isDirectory()) {
                  getAllFiles(filePath, fileList);
                } else {
                  const relativePath = path.relative(dirName, filePath);
                  fileList.push(relativePath);
                }
              });
              return fileList;
            }
            getAllFiles(dirName, assets);
          } else {
            assets.push("favicon.ico");
          }
        });
      });
    },
  };
}

export default createProxyPlugin;
